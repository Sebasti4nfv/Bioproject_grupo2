{% extends "analisis/base.html" %}
{% block content %}
<div class="container mt-5">

  <h3 class="mb-4 text-center">üìä Panel de Monitoreo Bioinform√°tico</h3>

  <!-- KPIs -->
  <div class="row text-center mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-success">
        <div class="card-body">
          <h5 class="text-success fw-bold">üß¨ Secuencias</h5>
          <h3>{{ total_sequences }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-primary">
        <div class="card-body">
          <h5 class="text-primary fw-bold">üîç An√°lisis</h5>
          <h3>{{ total_jobs }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-info">
        <div class="card-body">
          <h5 class="text-info fw-bold">üß´ Genes RAM</h5>
          <h3>{{ total_genes }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm border-danger">
        <div class="card-body">
          <h5 class="text-danger fw-bold">‚ö† Casos Cr√≠ticos</h5>
          <h3>{{ high_risk }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Promedios -->
  <div class="row text-center mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm border-secondary">
        <div class="card-body">
          <h6>Identidad promedio (%)</h6>
          <h3 class="text-secondary fw-bold">{{ avg_identity }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm border-secondary">
        <div class="card-body">
          <h6>Cobertura promedio (%)</h6>
          <h3 class="text-secondary fw-bold">{{ avg_coverage }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Gr√°ficos -->
  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white text-center">Distribuci√≥n por Clase Antibi√≥tica</div>
        <div class="card-body">
          <canvas id="classChart" height="200"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white text-center">Distribuci√≥n por Fuente (CARD / ResFinder)</div>
        <div class="card-body">
          <canvas id="sourceChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-12 mt-4">
  <div class="card shadow-sm">
    <div class="card-header bg-dark text-white text-center">üìà Casos Cr√≠ticos por Fecha</div>
    <div class="card-body">
      <canvas id="riskChart" height="120"></canvas>
    </div>
  </div>
  </div>
 
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const classData = {{ genes_by_class|safe }};
  const classLabels = classData.map(item => item.antibiotic_class || "Sin clase");
  const classCounts = classData.map(item => item.total);

  const ctx1 = document.getElementById('classChart');
  new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: classLabels,
      datasets: [{
        label: 'Genes detectados',
        data: classCounts,
        backgroundColor: 'rgba(54, 162, 235, 0.6)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });

  const sourceData = {{ genes_by_source|safe }};
  const sourceLabels = sourceData.map(item => item.source || "Desconocido");
  const sourceCounts = sourceData.map(item => item.total);

  const ctx2 = document.getElementById('sourceChart');
  new Chart(ctx2, {
    type: 'pie',
    data: {
      labels: sourceLabels,
      datasets: [{
        label: 'Distribuci√≥n por fuente',
        data: sourceCounts,
        backgroundColor: [
          'rgba(255, 99, 132, 0.6)',
          'rgba(75, 192, 192, 0.6)',
        ],
        borderColor: '#fff',
        borderWidth: 1
      }]
    },
    options: { responsive: true }
  });
</script>
<script>
  const riskData = {{ cases_by_date|safe }};
  const dates = riskData.map(item => item.date);
  const counts = riskData.map(item => item.count);

  const ctx3 = document.getElementById('riskChart');
  new Chart(ctx3, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Casos Cr√≠ticos',
        data: counts,
        borderColor: 'rgba(255, 99, 132, 1)',
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        borderWidth: 2,
        fill: true,
        tension: 0.4,
        pointRadius: 4
      }]
    },
    options: {
      scales: { y: { beginAtZero: true } },
      responsive: true,
      plugins: { legend: { position: 'top' } }
    }
  });
</script>
{% endblock %}
